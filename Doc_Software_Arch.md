## 软件架构设计


### 0 适用范围
1.	本设计规范，仅仅适用于空调精灵的软件架构部分
2.	第3章模块划分中所列的模块，特制软件功能模块

### 1 设计原则
1.	低耦合，高内聚
2.	便于单元测试，便于集成测试

### 2 设计要点
1.	禁止两个模块直接通信
3.	动态加载和卸载模块，模块的存在与否不影响系统稳定性
4.	消息动态绑定，发送消息者不依赖特定的模块接收者
5.	充分隔离，单个模块尽可能少的关联其他模块
6.	主控模块负责整体工作，外围模块被动接收消息和执行动作

### 3 模块划分
1.	红外模块
2.	主控模块
3.	消息处理模块
4.	蓝牙模块
5.	Wi-Fi模块
6.	服务器模块
7.	手机模块
8.	人机输出模块
9.	人机输入模块

### 4 模块功能定义
1.	红外模块
	1. 负责控制红外部分的硬件
	2. 负责红外信号的编码，解码，学习，复现
	3. 只负责处理消息处理模块发送的消息，执行动作	
2.	主控模块
	1. 负责协调整个系统
	2. 只能通过`消息处理模块`间接和各个模块通信，完成控制功能
3.	消息处理模块
	1. 负责接收和转发所有的模块消息
	2. 利用消息处理模块来完成解耦和动态绑定功能
4.	蓝牙模块
	1. 负责连接手机模块
	2. 负责将手机命令通过`消息处理模块`转发到`主控模块`
	3. 只能与`服务器模块`和`消息处理模块通信`
5.	Wi-Fi模块
	1. 负责连接internet网络进行数据库更新
	2. 负责连接MQTT服务器，接收和发送MQTT消息
	3. 只能与`服务器模块`和`消息处理模块通信`
6.	服务器模块
	1. 负责连接空调精灵和手机模块
	2. 采用MQTT协议封装
	3. 只能与Wi-Fi模块和手机模块交互
7.	手机模块
	1. 通过蓝牙或者Wi-Fi来控制空调精灵
	2. 该模块只存在于手机端，以APP的形式存在
	3. 手机模块只能与MQTT服务器或者空调精灵蓝牙4.0模块交互
	4. 手机模块应用层协议，包括但不限于Wi-Fi链路和BLE4.0链路
8.	人机输出模块
	1. 负责显示各种可视化信息
	2. 负责处理`消息处理模块`发送过来的`主控消息`，并执行相应的显示动作
9.	人机输入模块
	1. 负责采集各种交互输入信号（按键，触摸动作）
	2. 将采集到的动作信号，通过`消息处理模块`发送到`主控模块`

### 5 模块行为定义
1.	红外模块（TODO）
2.	主控模块（TODO）
3.	消息处理模块（TODO）
4.	蓝牙模块（TODO）
5.	Wi-Fi模块（TODO）
6.	服务器模块（TODO）
7.	手机模块（TODO）
8.	人机输出模块（TODO）
9.	人机输入模块（TODO）

### 6 模块相关性


| - | 红外 | 主控 | 消息处理 | 蓝牙 | Wi-Fi | 服务器 | 手机 | 人机输出 | 人机输入 |
| :---: | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| 红外     |  |  | * |  |  |  |  |  |  |
| 主控     |  |  | * |  |  |  |  |  |  |
| 消息处理  | * | * |  | * | * |  |  | * | * |
| 蓝牙     |  |  | * |  |  |  | * |  |  |
| Wi-Fi   |  |  | * |  |  | * |  |  |  |
| 服务器   |  |  |  |  | * |  | * |  |  |
| 手机     |  |  |  | * |  | * |  |  |  |
| 人机输出 |  |  | * |  |  |  |  |  |  |
| 人机输入 |  |  | * |  |  |  |  |  |  |


### 7 通信协议
1.	消息处理模块协议（TODO）
2.	服务器通信MQTT协议（TODO）
3.	手机控制协议（TODO）
4.	红外描述协议（TODO）

### 8 测试指导
#### 8.1 单元测试
1.	软件架构设计者编写RTOS软件框架，提供消息分发模块和主控模块
2.	模块A实现者，先按照协议标准，实现特定消息的接收和处理；然后编写测试线程，模拟相关模块B行为和动作，从而测试自身模块A的功能是否正常
3.	模块实现者，应充分考虑 1）错误处理  2）模块自身状态处理机制，杜绝任何阻塞CPU操作

#### 8.2 集成测试
1.	在集成测试之前，每个模块实现者，应保证自身的模块已经通过单元测试，并提供相应的Test Case
2.	软件集成者负责整体模块测试，如发现bug，则应反馈给对应的模块负责人

### 9 版本记录
| 序列号 | 版本号 | 修改时间 | 修改内容 | 修改者 |
| :---: | ----- | ----- | ----- | ----- |
| 1 | V1.0 | 2015-10-14 | First init | cedar |

