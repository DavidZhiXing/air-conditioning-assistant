## 软件架构设计


### 0 适用范围
1.	本设计规范，仅仅适用于空调精灵的软件架构部分
2.	第3章模块划分中所列的模块，特制软件功能模块

### 1 设计原则
1.	低耦合，高内聚
2.	便于单元测试，便于集成测试

### 2 设计要点
1.	禁止两个模块直接通信
3.	动态加载和卸载模块，模块的存在与否不影响系统稳定性
4.	消息动态绑定，发送消息者不依赖特定的模块接收者
5.	充分隔离，单个模块尽可能少的关联其他模块
6.	主控模块负责整体工作，外围模块被动接收消息和执行动作

### 3 模块划分
1.	红外模块
2.	主控模块
3.	消息处理模块
4.	蓝牙模块
5.	Wi-Fi模块
6.	服务器模块
7.	手机模块
8.	人机输出模块
9.	人机输入模块

### 4 模块功能定义
1.	红外模块
	1. 负责控制红外部分的硬件
	2. 负责红外信号的编码，解码，学习，复现
	3. 只负责处理消息处理模块发送的消息，执行动作	
2.	主控模块
	1. 负责协调整个系统
	2. 只能通过`消息处理模块`间接和各个模块通信，完成控制功能
3.	消息处理模块
	1. 负责接收和转发所有的模块消息
	2. 利用消息处理模块来完成解耦和动态绑定功能
4.	蓝牙模块
	1. 负责连接手机模块
	2. 负责将手机命令通过`消息处理模块`转发到`主控模块`
	3. 只能与`服务器模块`和`消息处理模块通信`
5.	Wi-Fi模块
	1. 负责连接internet网络进行数据库更新
	2. 负责连接MQTT服务器，接收和发送MQTT消息
	3. 只能与`服务器模块`和`消息处理模块通信`
6.	服务器模块
	1. 负责连接空调精灵和手机模块
	2. 采用MQTT协议封装
	3. 只能与Wi-Fi模块和手机模块交互
7.	手机模块
	1. 通过蓝牙或者Wi-Fi来控制空调精灵
	2. 该模块只存在于手机端，以APP的形式存在
	3. 手机模块只能与MQTT服务器或者空调精灵蓝牙4.0模块交互
	4. 手机模块应用层协议，包括但不限于Wi-Fi链路和BLE4.0链路
8.	人机输出模块
	1. 负责显示各种可视化信息
	2. 负责处理`消息处理模块`发送过来的`主控消息`，并执行相应的显示动作
9.	人机输入模块
	1. 负责采集各种交互输入信号（按键，触摸动作）
	2. 将采集到的动作信号，通过`消息处理模块`发送到`主控模块`

### 5 模块行为定义
1.	红外模块
	1. 上电后，接收到初始化命令，初始化红外硬件，如果因故障无法完成初始化，则不返回任何初始化应答信息
	2.  红外内部管理各种IR协议，并根据主机对应的配置，来发送IR协议帧
	3.  主控可以查询红外协议的种类，红外模块返回对应的查询结果
	4.  主控可以将红外模块配置成特定协议模式，红外此后的动作完全采用这个协议，除非主控主动更改协议模式
	5.  红外接收主控的逻辑动作，然后转换成对应的红外协议信息，发送出去
2.	主控模块
	1.	 处理逻辑部分
3.	消息处理模块
	1. 处理模块维护系统所有模块的注册信息
	2. 处理模块接收其它模块消息，并检查消息完整性，然后转发到对应的接收模块
	3. 如果没有消息接收方，消息处理模块负责销毁这个消息
4.	蓝牙模块
	1.  上电后，接收到初始化命令，初始化硬件，如果因故障无法完成初始化，则不返回任何初始化应答信息
	2.	上电后，启动蓝牙4.0Client模式，等待手机连接
	3.	手机建立连接后，发送特征码，用于身份校验；特征码格式，参见下文协议单元说明
	4.	主控模式接收到BLE4.0状态更新信息，根据自己的实际硬件情况，发送HMI更新信息
5.	Wi-Fi模块
	1.	上电后，接收到初始化命令，初始化硬件，如果因故障无法完成初始化，则不返回任何初始化应答信息
	2.	上电后，启动热点模式，用于配置家庭Wi-Fi的账号和密码
	3.	账号和密码设置完毕，启动Client模式，准备连接家庭Wi-Fi，连接成功后，向主控模块发送连接状态信息
	4.	主控模式接收到Wi-Fi状态更新信息，根据自己的实际硬件情况，发送HMI更新信息
6.	服务器模块
	1.	接收手机模块发送的MQTT请求，并将请求转发至红外精灵WI-FI模块
7.	手机模块
	1.	与MQTT服务器进行通讯，双向通讯协议
	2.	向MQTT服务器发送控制命令，从而控制红外硬件
	3.	注：本部分由安卓手机实现
8.	人机输出模块
	1.	 上电后，接收到初始化命令，初始化硬件，如果因故障无法完成初始化，则不返回任何初始化应答信息
	2.	 负责接收显示命令，并在对应的HMI输出装置显示（e.g：在LCD屏幕上显示红外协议名称和执行动作）

9.	人机输入模块
	1.	 上电后，接收到初始化命令，初始化硬件，如果因故障无法完成初始化，则不返回任何初始化应答信息
	2.	 负责HMI输入信息，并转换成标准动作命令，发送到主控模块

### 6 模块相关性


| - | 红外 | 主控 | 消息处理 | 蓝牙 | Wi-Fi | 服务器 | 手机 | 人机输出 | 人机输入 |
| :---: | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| 红外     |  |  | * |  |  |  |  |  |  |
| 主控     |  |  | * |  |  |  |  |  |  |
| 消息处理  | * | * |  | * | * |  |  | * | * |
| 蓝牙     |  |  | * |  |  |  | * |  |  |
| Wi-Fi   |  |  | * |  |  | * |  |  |  |
| 服务器   |  |  |  |  | * |  | * |  |  |
| 手机     |  |  |  | * |  | * |  |  |  |
| 人机输出 |  |  | * |  |  |  |  |  |  |
| 人机输入 |  |  | * |  |  |  |  |  |  |


### 7 通信协议
1.	消息处理模块协议（TODO）
2.	服务器通信MQTT协议（TODO）
3.	手机控制协议（TODO）
4.	红外描述协议（TODO）

### 8 测试指导
#### 8.1 单元测试
1.	软件架构设计者编写RTOS软件框架，提供消息分发模块和主控模块
2.	模块A实现者，先按照协议标准，实现特定消息的接收和处理；然后编写测试线程，模拟相关模块B行为和动作，从而测试自身模块A的功能是否正常
3.	模块实现者，应充分考虑 1）错误处理  2）模块自身状态处理机制，杜绝任何阻塞CPU操作

#### 8.2 集成测试
1.	在集成测试之前，每个模块实现者，应保证自身的模块已经通过单元测试，并提供相应的Test Case
2.	软件集成者负责整体模块测试，如发现bug，则应反馈给对应的模块负责人

### 9 版本记录
| 序列号 | 版本号 | 修改时间 | 修改内容 | 修改者 |
| :---: | ----- | ----- | ----- | ----- |
| 1 | V1.0 | 2015-10-14 | First init | cedar |
| 1 | V1.1 | 2015-10-26 | 增加行为定义 | cedar |
